<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PCR Gear Tuner</title>
<style>
  :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent2:#38bdf8; }
  html,body{background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
  h1,h2,h3{margin:0 0 .5rem 0}
  .wrap{max-width:1100px; margin:2rem auto; padding:0 1rem}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:1rem}
  .panel{background:var(--panel); border-radius:.75rem; padding:1rem; box-shadow:0 1px 2px rgba(0,0,0,.2)}
  .row{display:grid; grid-template-columns:200px 1fr 110px; gap:.75rem; align-items:center; margin:.5rem 0}
  .row label{color:var(--muted)}
  .row .lock{grid-column:1 / span 3; display:flex; gap:.5rem; align-items:center; margin-top:.25rem}
  input[type=range]{width:100%}
  input[type=number]{width:100%; padding:.35rem .5rem; background:#0b1220; border:1px solid #334155; color:#e5e7eb; border-radius:.4rem}
  input[readonly]{opacity:.7}
  .muted{color:var(--muted); font-size:.9rem}
  table{width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums}
  th,td{padding:.4rem .5rem; border-bottom:1px solid #1f2937}
  th{color:#cbd5e1; text-align:left; font-weight:600}
  .pill{display:inline-block; padding:.1rem .5rem; border-radius:999px; background:#0b1220; border:1px solid #334155; color:#cbd5e1}
  .btnbar{display:flex; gap:.5rem; flex-wrap:wrap; margin:.5rem 0 0}
  button{background:#0b1220; border:1px solid #334155; color:#e5e7eb; padding:.45rem .75rem; border-radius:.5rem; cursor:pointer}
  button:hover{border-color:#64748b}
</style>
</head>
<body>
<div class="wrap">
  <h1>PCR Gear Tuner</h1>
  <p class="muted">Interactive gear calculator with exportable tunes. Tire diameter defaults to <strong>22.96 in</strong> and is locked until you unlock it.</p>

  <div class="panel">
    <div class="grid">
      <div>
        <h2>Common Inputs</h2>
        <div class="row">
          <label>Shift RPM (Before shift)</label>
          <input id="shiftRPM" type="range" min="4000" max="11000" step="50" value="8200"
                 oninput="byId('shiftRPM_val').value=this.value; recalc()"/>
          <input id="shiftRPM_val" type="number" min="1000" max="12000" step="10" value="8200"
                 oninput="byId('shiftRPM').value=this.value; recalc()"/>
        </div>
        <div class="row">
          <label>Target RPM after shift</label>
          <input id="afterRPM" type="range" min="3000" max="11000" step="50" value="7100"
                 oninput="byId('afterRPM_val').value=this.value; recalc()"/>
          <input id="afterRPM_val" type="number" step="10" value="7100"
                 oninput="byId('afterRPM').value=this.value; recalc()"/>
        </div>
        <div class="row">
          <label>Tire diameter (inches)</label>
          <input id="tireDia" type="range" min="18" max="30" step="0.01" value="22.96" disabled
                 oninput="byId('tireDia_val').value=this.value; recalc()"/>
          <input id="tireDia_val" type="number" step="0.01" value="22.96" readonly
                 oninput="byId('tireDia').value=this.value; recalc()"/>
          <div class="lock">
            <input id="unlockTire" type="checkbox" onchange="toggleTireEdit()">
            <span class="muted">Unlock to edit tire diameter</span>
          </div>
        </div>
      </div>
      <div>
        <h2>Mode</h2>
        <div class="row">
          <label>Auto progression (geometric)</label>
          <input id="autoProg" type="checkbox" checked onchange="recalc()"/>
          <span class="pill">ratio = after / before</span>
        </div>
        <div class="row">
          <label>Show comparison setup B</label>
          <input id="showB" type="checkbox" checked
                 onchange="document.getElementById('blockB').style.display=this.checked?'block':'none'; recalc()"/>
          <span class="pill">A vs. B</span>
        </div>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:1rem">
    <!-- SETUP A -->
    <div class="panel" id="blockA">
      <h2>Setup A <span class="muted">("Stock" / Auto)</span></h2>
      <div class="row">
        <label>Final drive</label>
        <input id="fdA" type="range" min="0" max="5" step="0.01" value="2.50"
               oninput="byId('fdA_val').value=this.value; recalc()"/>
        <input id="fdA_val" type="number" step="0.01" value="2.50"
               oninput="byId('fdA').value=this.value; recalc()"/>
      </div>
      <div id="gearsA"></div>
      <div class="btnbar">
        <button onclick="exportSetup('A')">Export Setup A</button>
      </div>
      <h3 style="margin-top:1rem">Results</h3>
      <div id="tableA"></div>
    </div>

    <!-- SETUP B -->
    <div class="panel" id="blockB">
      <h2>Setup B <span class="muted">(Custom)</span></h2>
      <div class="row">
        <label>Final drive</label>
        <input id="fdB" type="range" min="0" max="5" step="0.01" value="4.49"
               oninput="byId('fdB_val').value=this.value; recalc()"/>
        <input id="fdB_val" type="number" step="0.01" value="4.49"
               oninput="byId('fdB').value=this.value; recalc()"/>
      </div>
      <div id="gearsB"></div>
      <div class="btnbar">
        <button onclick="exportSetup('B')">Export Setup B</button>
      </div>
      <h3 style="margin-top:1rem">Results</h3>
      <div id="tableB"></div>
    </div>
  </div>
</div>

<script>
/* ---------- Utilities ---------- */
const byId = (id)=>document.getElementById(id);
const fmt = (n, d=2) => Number(n).toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d});
const round2 = (x)=> Math.round((+x + Number.EPSILON)*100)/100;
const clamp = (val, min, max)=> Math.min(max, Math.max(min, val));
const safeFmt = (n, d=2)=> Number.isFinite(n) ? fmt(n, d) : '';

function toggleTireEdit(){
  const unlocked = byId('unlockTire').checked;
  byId('tireDia').disabled = !unlocked;
  byId('tireDia_val').readOnly = !unlocked;
  // Ensure slider & number are in sync and trigger a recalc when toggled
  if(unlocked){
    byId('tireDia').value = byId('tireDia_val').value;
  } else {
    // Re-lock to default if user wants; we keep current value but still recalc
  }
  recalc();
}

/* ---------- Defaults ---------- */
const defaultsA = [3.5, 3.0304878048780486, 2.623958953004164, 2.2719644593084833, 1.9671887391573453, 1.70329756683136];
const defaultsB = [1.61, 1.40, 1.19, 1.01, 0.86, 0.75];

/* ---------- UI builders ---------- */
function gearInputs(blockId, prefix, defaults){
  const el = byId(blockId); el.innerHTML = '';
  const titles = ['1st','2nd','3rd','4th','5th','6th'];
  defaults.forEach((val, idx)=>{
    const i = idx+1;
    const row = document.createElement('div'); row.className='row';
    const label = document.createElement('label'); label.textContent = titles[idx]+' gear ratio';
    const range = document.createElement('input');
    range.type='range'; range.min='0'; range.max='4'; range.step='0.01';
    range.id = prefix+'G'+i; range.value = round2(val);
    const num = document.createElement('input');
    num.type='number'; num.step='0.01'; num.min='0'; num.max='4';
    num.id = prefix+'G'+i+'_val'; num.value = round2(val);
    range.oninput = () => { num.value = round2(range.value); recalc(); };
    num.oninput = () => { range.value = round2(num.value); recalc(); };
    row.appendChild(label); row.appendChild(range); row.appendChild(num);
    el.appendChild(row);
  });
}

function mphAt(rpm, gear, fd, dia){
  if (gear <= 0 || fd <= 0) return NaN;
  return rpm * (Math.PI * dia) / (gear * fd * 1056);
}

function buildTable(fd, gears, shiftRPM, tireDia){
  const rows = [];
  for(let i=0; i<gears.length; i++){
    const g = +gears[i];
    const speed = mphAt(shiftRPM, g, fd, tireDia);
    let drop = '' , after = '', into='';
    if(i < gears.length-1){
      const next = +gears[i+1];
      const afterRPM = (g > 0) ? (shiftRPM * (next/g)) : NaN;
      drop = Number.isFinite(afterRPM) ? (shiftRPM - afterRPM) : NaN;
      after = afterRPM;
      into = `in ${['2nd','3rd','4th','5th','6th','7th'][i] || ''} Gear`;
    }
    rows.push({gearLabel:['1st','2nd','3rd','4th','5th','6th'][i], gear:g, speed, drop, after, into});
  }
  let html = '<table><thead><tr><th>Gear</th><th>Ratio</th><th>Top speed @ ' + fmt(shiftRPM,0) + ' RPM</th><th>RPM drop</th><th>RPM after</th><th></th></tr></thead><tbody>';
  rows.forEach(r=>{
    html += `<tr>
      <td>${r.gearLabel}</td>
      <td>${fmt(round2(r.gear),2)}</td>
      <td>${safeFmt(r.speed,2)} mph</td>
      <td>${r.drop!==''?safeFmt(r.drop,2):''}</td>
      <td>${r.after!==''?safeFmt(r.after,2):''}</td>
      <td class="muted">${r.into}</td>
    </tr>`;
  })
  html += '</tbody></table>';
  return html;
}

/* ---------- Export logic ---------- */
function getSetup(prefix){
  const shift = parseFloat(byId('shiftRPM').value);
  const after = parseFloat(byId('afterRPM').value);
  const tireDia = parseFloat(byId('tireDia_val').value);
  const fd = round2(clamp(parseFloat(byId('fd'+prefix).value),0,5));
  const gears = [1,2,3,4,5,6].map(i=> round2(clamp(parseFloat(byId(prefix+'G'+i+'_val').value),0,4)));
  return {shift, after, tireDia, fd, gears};
}

function exportSetup(prefix){
  const id = (prefix==='A'?'Setup A':'Setup B');
  const {shift, after, tireDia, fd, gears} = getSetup(prefix);
  const now = new Date();
  const ts = now.toISOString().replace(/[-:T]/g,'').slice(0,15);
  let lines = [];
  lines.push(`PCR Gear Tuner - ${id}`);
  lines.push(`Timestamp: ${now.toISOString()}`);
  lines.push('');
  lines.push('[Common Inputs]');
  lines.push(`Shift RPM (before): ${fmt(shift,0)}`);
  lines.push(`Target RPM after:   ${fmt(after,0)}`);
  lines.push(`Tire diameter (in): ${fmt(tireDia,2)}`);
  lines.push('');
  lines.push(`[${id}]`);
  lines.push(`Final drive: ${fmt(fd,2)}`);
  lines.push('Gears (ratio): ' + gears.map(g=>fmt(g,2)).join(', '));
  lines.push('');
  lines.push('Per-gear results at shift RPM:');
  for(let i=0;i<gears.length;i++){
    const g = gears[i];
    const mph = mphAt(shift, g, fd, tireDia);
    let afterRPM = NaN, drop = NaN;
    if(i < gears.length-1 && g > 0){
      const next = gears[i+1];
      afterRPM = shift * (next / g);
      drop = shift - afterRPM;
    }
    const gearName = ['1st','2nd','3rd','4th','5th','6th'][i];
    lines.push(`${gearName.padEnd(4)} | Ratio ${fmt(g,2).padStart(5)} | Top ${safeFmt(mph,2).padStart(7)} mph` +
               (Number.isFinite(afterRPM) ? ` | After ${fmt(afterRPM,2).padStart(7)} rpm | Drop ${fmt(drop,2).padStart(7)} rpm` : ''));
  }
  const content = lines.join('\n');
  const blob = new Blob([content], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `PCR_Tune_${prefix}_${ts}.txt`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

/* ---------- Recalc pipeline ---------- */
function recalc(){
  const shift = parseFloat(byId('shiftRPM').value);
  const after = parseFloat(byId('afterRPM').value);
  const tireDia = parseFloat(byId('tireDia_val').value);
  const auto = byId('autoProg').checked;

  // Setup A
  const GA = [1,2,3,4,5,6].map(i=> round2(parseFloat(byId('A'+'G'+i+'_val').value)));
  if(auto){
    const r = after/shift; // geometric step
    for(let i=1;i<GA.length;i++) GA[i] = round2(GA[i-1]*r);
    for(let i=1;i<GA.length;i++){
      byId('A'+'G'+(i+1)).value = GA[i].toFixed(2);
      byId('A'+'G'+(i+1)+'_val').value = GA[i].toFixed(2);
    }
  }
  const fdA = round2(clamp(parseFloat(byId('fdA').value),0,5));
  byId('fdA').value = fdA.toFixed(2); byId('fdA_val').value = fdA.toFixed(2);
  byId('tableA').innerHTML = buildTable(fdA, GA, shift, tireDia);

  // Setup B
  const GB = [1,2,3,4,5,6].map(i=> round2(clamp(parseFloat(byId('B'+'G'+i+'_val').value),0,4)));
  for(let i=0;i<GB.length;i++){
    byId('B'+'G'+(i+1)).value = GB[i].toFixed(2);
    byId('B'+'G'+(i+1)+'_val').value = GB[i].toFixed(2);
  }
  const fdB = round2(clamp(parseFloat(byId('fdB').value),0,5));
  byId('fdB').value = fdB.toFixed(2); byId('fdB_val').value = fdB.toFixed(2);
  byId('tableB').innerHTML = buildTable(fdB, GB, shift, tireDia);
}

/* ---------- Init ---------- */
function init(){
  gearInputs('gearsA','A',defaultsA);
  gearInputs('gearsB','B',defaultsB);
  // Ensure initial sync between tire slider and number
  byId('tireDia').value = byId('tireDia_val').value;
  recalc();
}
init();
</script>
</body>
</html>
